{\rtf1\ansi\ansicpg1252\cocoartf2822
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\paperw11900\paperh16840\margl1440\margr1440\vieww16680\viewh10300\viewkind0
\pard\tx566\tx1133\tx1700\tx2267\tx2834\tx3401\tx3968\tx4535\tx5102\tx5669\tx6236\tx6803\pardirnatural\partightenfactor0

\f0\fs24 \cf0 <?php\
namespace AISectionSummaries;\
\
class Summarizer \{\
    private $api_key;\
\
    public function __construct() \{\
        $settings = get_option( 'ai_section_summaries_settings', [] );\
        $this->api_key = $settings['openai_api_key'] ?? '';\
    \}\
\
    public function summarize( string $text, int $length = 2 ): string \{\
        if ( empty( $this->api_key ) ) return 'Missing OpenAI API key.';\
\
        $prompt = "Summarize the following text in \{$length\} sentences in neutral tone:\
\
" . mb_substr( $text, 0, 3000 );\
\
        $response = wp_remote_post( 'https://api.openai.com/v1/chat/completions', [\
            'headers' => [\
                'Content-Type'  => 'application/json',\
                'Authorization' => 'Bearer ' . $this->api_key,\
            ],\
            'body'    => wp_json_encode([\
                'model'    => 'gpt-3.5-turbo',\
                'messages' => [\
                    [ 'role' => 'system', 'content' => 'You are an assistant that summarizes political articles.' ],\
                    [ 'role' => 'user',   'content' => $prompt ],\
                ],\
                'max_tokens' => 150,\
            ]),\
            'timeout' => 15,\
        ]);\
\
        if ( is_wp_error( $response ) ) return 'Could not connect to AI service.';\
\
        $code = wp_remote_retrieve_response_code( $response );\
        if ( $code !== 200 ) return "AI API error (HTTP $code).";\
\
        $body = wp_remote_retrieve_body( $response );\
        $data = json_decode( $body, true );\
        $summary = trim( $data['choices'][0]['message']['content'] ?? '' );\
\
        return $summary !== '' ? esc_html( $summary ) : 'No summary generated.';\
    \}\
\} \
}